# Infra
## Homework 5
#### 1. How to connect internalhost through bastion

```
* ssh 10.132.0.3 -o ProxyCommand="ssh -W %h:%p 35.205.76.161"
* ssh 10.132.0.3 -o ProxyCommand="ssh 35.205.76.161 nc %h %p 2> /dev/null"
* ssh -J 35.205.76.161 10.132.0.3
```
Using .ssh/config
```
Host *
    AddKeysToAgent yes
    IdentityFile ~/.ssh/id_rsa
    UseKeychain yes
    ServerAliveInterval 30

host bastion
    hostname 35.205.76.161

host internalhost
    hostname 10.132.0.3
    proxyjump bastion
```
Another examples
```
host internalhost
    hostname 10.132.0.3
    ProxyCommand ssh -W %h:%p bastion

host internalhost
    hostname 10.132.0.3
    ProxyCommand ssh bastion nc %h %p 2> /dev/null
```
#### 2. Host configuration.
```
Хост bastion, внешний IP: 35.205.76.161, внутренний IP: 10.132.0.2
Хост: internalhost, внутренний IP: 10.132.0.3
```
## Homework 6
#### Manual install:
* Install Ruby `config-scripts/install_ruby.sh`
* Install MongoDB `config-scripts/install_mongodb.sh`
* Deploy App `config-scripts/deploy.sh`

#### Auto install through [Google Cloud Platform](https://cloud.google.com/)
use this command to install app via google cli:
```
gcloud compute instances create reddit-app \
  --boot-disk-size=10GB \
  --image-family ubuntu-1604-lts \
  --image-project=ubuntu-os-cloud \
  --machine-type=g1-small \
  --tags puma-server \
  --restart-on-failure \
  --zone=europe-west1-d \
  --metadata-from-file startup-script=config-scripts/startup-script.sh
```
## Homework 7
#### Create image with HashiCorp Packer
```
packer build \
-var-file=variables.json \
immutable.json
```
#### Run reddit app
Use [Google Cloud Platform](https://cloud.google.com/)
```
gcloud compute instances create reddit-app \
  --boot-disk-size=10GB \
  --image-family reddit-full \
  --machine-type=g1-small \
  --tags puma-server \
  --restart-on-failure \
  --zone=europe-west1-d
```
or run script
```
config-scripts/create-reddit-vm.sh
```
## Homework 8
#### Deploy reddit app using [GCP](https://cloud.google.com/) and [Terraform](https://www.terraform.io/)

This work shows how you can run two reddit-app instances from reddit-app image which we created at Homework 07  with HTTP load balancer without autoscale. Also you can see how to add several ssh-keys to the whole project. We have some files in terrafrom directory:
- `main.ft` - main terrafrom config file
- `outputs.tf` - is important data of attribute values (public IP addresses); this data is outputted when apply is called
- `variables.tf` - This defines some variables within our terraform configuration.
- `terraform.tfvars.example` - example for `terraform.tfvars` file with assigned variables; you should create `terraform.tfvars` in terraform directory yourself. It contains path to your ssh-keys, image family, project ID

To run app you should use this commands
```bash
terraform init # performs several different initialization steps in order to prepare a working directory for use
terraform plan # convenient way to check whether the execution plan for a set of changes matches your expectations without making any changes to real resources or to the state
terraform apply # apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a `terraform plan` execution plan
```

## Homework 9
#### Add modules to a project

Now we separate environment: prod (ssh access from 5.16.0.0/14) and stage (ssh from everywhere) also use modules for each instance `reddit-app` and `reddit-db`
 - build instances
```bash
~/terraform/{prod | stage}$ terraform init
~/terraform/{prod | stage}$ terraform plan
~/terraform/{prod | stage}$ terraform apply
```
- add `storage-bucket.tf`

```bash
gsutil ls
gs://storage-bucket-test-93389695/
gs://storage-bucket-test2-2226613/
```

## Homework 10
#### Add ansible to `infra` project

- install ansible

```bash
brew install ansible
```
- add `ansible.cfg`

```bash
$ cat ansible.cfg
[defaults]
inventory = ./inventory
remote_user = appuser
private_key_file = ~/.ssh/appuser
host_key_checking = False
```
- add different types for inventory file `inventory`, `inventory.yaml`, `inventory.json`
- test some commands to test and deploy `reddit-app`

```bash
ansible dbserver -m command -a uptime
ansible all -m ping
ansible all -m ping -i inventory.json
ansible app -m shell -a 'ruby -v; bundler -v'
ansible db -m command -a 'systemctl status mongod'
ansible db -m shell -a 'systemctl status mongod'
ansible db -m systemd -a name=mongod
ansible db -m service -a name=mongod
ansible app -m git -a 'repo=https://github.com/Otus-DevOps-2017-11/reddit.git dest=/home/appuser/reddit'
ansible app -m command -a 'git clone https://github.com/Otus-DevOps-2017-11/reddit.git dest=/home/appuser/reddit'
```

